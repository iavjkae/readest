services:
  trailbase:
    image: trailbase/trailbase:latest
    container_name: readest-trailbase
    ports:
      - "4000:4000"
    environment:
      # Listen on all interfaces inside the container.
      ADDRESS: "0.0.0.0:4000"
    volumes:
      - trailbase_depot:/app/traildepot
    command: ["/app/trail", "run"]

  readest-web:
    build:
      context: .
      dockerfile: Dockerfile.release
      args:
        # Public URL for browser clients (baked at build-time into Next.js).
        NEXT_PUBLIC_TRAILBASE_URL: "http://trailbase:4000"
    container_name: readest-web
    depends_on:
      - trailbase
    ports:
      - "3000:3000"
    environment:
      # Server-side URL (used by Next.js server runtime inside the container).
      TRAILBASE_URL: "http://trailbase:4000"

      # Dev-only convenience: allow decoding JWTs without signature verification.
      # For production, set TRAILBASE_JWT_PUBLIC_KEY_PEM and keep this false.
      TRAILBASE_ALLOW_UNVERIFIED_JWT: "true"

      # Used by webhook handlers (e.g. Stripe) when there is no user session.
      # Leave empty unless you enable those webhooks.
      TRAILBASE_SERVICE_TOKEN: ""

volumes:
  trailbase_depot:
    name: readest_trailbase_depot
